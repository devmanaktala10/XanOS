#include "cirrus.h"

/* 1280x1024x16 */
// static uint16_t cseq_1280x1024x16[18] = {
//     0x0300,0x2101,0x0f02,0x0003,0x0e04,0x1707, //
//     0x760b,0x760c,0x760d,0x760e,
//     0x0412,0x0013,0x2017,
//     0x341b,0x341c,0x341d,0x341e,
//     0xffff
// };
// static uint16_t ccrtc_1280x1024x16[24] = {
//     0x2911,0xc300,0x9f01,0x9f02,0x8603,0x8304,0x9405,0x2406,0xf707,
//     0x6009,0x000c,0x000d,
//     0x0310,0xff12,0x4013,0x4014,0xff15,0x2416,0xc317,0xff18,
//     0x001a,0x321b,0x001d,
//     0xffff
// };


static uint16_t cseq_1280x1024x8[18] = {
    0x0300,0x2101,0x0f02,0x0003,0x0e04,0x1107,
    0x760b,0x760c,0x760d,0x760e,
    0x0412,0x0013,0x2017,
    0x341b,0x341c,0x341d,0x341e,
    0xffff
};
static uint16_t ccrtc_1280x1024x8[24] = {
    0x2911,0xc300,0x9f01,0x9f02,0x8603,0x8304,0x9405,0x2406,0xf707,
    0x6009,0x000c,0x000d,
    0x0310,0xff12,0xa013,0x4014,0xff15,0x2416,0xc317,0xff18,
    0x001a,0x221b,0x001d,
    0xffff
};

/* 1280x1024x8 */
// static uint16_t cseq[18] = {
//     0x0300,0x2101,0x0f02,0x0003,0x0e04,0x1107,
//     0x760b,0x760c,0x760d,0x760e,
//     0x0412,0x0013,0x2017,
//     0x341b,0x341c,0x341d,0x341e,
//     0xffff
// };

// static uint16_t ccrtc[24] = {
//     0x2911,0xc300,0x9f01,0x9f02,0x8603,0x8304,0x9405,0x2406,0xf707, //9
//     0x6009,0x000c,0x000d, // 3
//     0x0310,0xff12,0xa013,0x4014,0xff15,0x2416,0xc317,0xff18, //8
//     0x001a,0x221b,0x001d, //3
//     0xffff // 1
// };

static uint16_t cgraph_svgacolor[13] = {
    0x0000,0x0001,0x0002,0x0003,0x0004,0x4005,0x0506,0x0f07,0xff08, // 9
    0x0009,0x000a,0x000b, // 3
    0xffff //1
};

//   0xa,0x3f,0x1,  0x36,0x36,0x36,  0xb,0xb,0xb,  0xd,0xd,0xd,  
// 0x3c,0x3c,0x3c,  0x8,0x8,0x8,  0x0,0x0,0x0,  0xf,0xf,0xf,

static uint8_t palette3[256*3]= {
   0x3f,0x08,0x1e,  0x3e,0x00,0x1e,  0x3f,0x17,0x1d,  0x3f,0x29,0x20, // 4 
   0x11,0x0e,0x1c,  0x06,0x2f,0x34,  0x01,0x3b,0x39,  0x3a,0x00,0x1d,  
   0x3f,0x30,0x20,  0x3f,0x3a,0x20,  0x3f,0x29,0x20,  0x3f,0x34,0x21,  
   0x1c,0x19,0x27,  0x01,0x3f,0x39,  0x00,0x32,0x33,  0x11,0x0e,0x1c, // 16 
   0x1b,0x1a,0x28,  0x10,0x0d,0x1a,  0x09,0x23,0x29,  0x1c,0x19,0x27,  
   0x18,0x16,0x24,  0x21,0x10,0x20,  0x00,0x3c,0x38,  0x25,0x10,0x21,  
   0x2e,0x24,0x1f,  0x2b,0x18,0x20,  0x1e,0x12,0x21,  0x25,0x0f,0x20, 
   0x1f,0x12,0x21,  0x0e,0x14,0x1f,  0x0b,0x1f,0x26,  0x09,0x21,0x27, // 32
   0x1b,0x11,0x1b,  0x19,0x10,0x1c,  0x24,0x18,0x20,  0x1a,0x11,0x1c,  
   0x15,0x0d,0x1b,  0x0c,0x1c,0x24,  0x10,0x12,0x1e,  0x0b,0x24,0x29,
   0x36,0x36,0x36,  0x3f,0x18,0x16,  0x3f,0x2f,0x0b,  0x09,0x32,0x10,  
   0x3a,0x2a,0x0a,  0x38,0x31,0x24,  0x0d,0x2b,0x0e,  0x09,0x32,0x0f, // 48
   0x25,0x32,0x25,  0x3b,0x13,0x11,  0x3e,0x15,0x13,  0x38,0x26,0x25, // 52
   0x3f,0x3f,0x3f,  0x2f,0x2f,0x2f,  0x30,0x30,0x30,  0x2b,0x2a,0x2a, // 56
   0x36,0x36,0x36,  0x0b,0x0b,0x0b,  0x0d,0x0d,0x0d,  0x3c,0x3c,0x3c, // 60
   0x08,0x08,0x08,  0x0f,0x0f,0x0f,  0x14,0x2b,0x38,  0x09,0x08,0x08, // 64

   0x34,0x11,0x12,  0x0d,0x22,0x2e,  0x32,0x01,0x0a,  0x1a,0x02,0x05, // 68
   0x26,0x26,0x26,  0x00,0x08,0x18,  0x23,0x2a,0x37,  0x31,0x16,0x04, // 72
   0x3f,0x39,0x26,

  0x1f,0x3f,0x27, 0x1f,0x3f,0x2f, 0x1f,0x3f,0x37,
  0x1f,0x3f,0x3f, 0x1f,0x37,0x3f, 0x1f,0x2f,0x3f, 0x1f,0x27,0x3f,
  0x2d,0x2d,0x3f, 0x31,0x2d,0x3f, 0x36,0x2d,0x3f, 0x3a,0x2d,0x3f,
  0x3f,0x2d,0x3f, 0x3f,0x2d,0x3a, 0x3f,0x2d,0x36, 0x3f,0x2d,0x31,
  0x3f,0x2d,0x2d, 0x3f,0x31,0x2d, 0x3f,0x36,0x2d, 0x3f,0x3a,0x2d,
  0x3f,0x3f,0x2d, 0x3a,0x3f,0x2d, 0x36,0x3f,0x2d, 0x31,0x3f,0x2d,
  0x2d,0x3f,0x2d, 0x2d,0x3f,0x31, 0x2d,0x3f,0x36, 0x2d,0x3f,0x3a,
  0x2d,0x3f,0x3f, 0x2d,0x3a,0x3f, 0x2d,0x36,0x3f, 0x2d,0x31,0x3f,
  0x00,0x00,0x1c, 0x07,0x00,0x1c, 0x0e,0x00,0x1c, 0x15,0x00,0x1c,
  0x1c,0x00,0x1c, 0x1c,0x00,0x15, 0x1c,0x00,0x0e, 0x1c,0x00,0x07,
  0x1c,0x00,0x00, 0x1c,0x07,0x00, 0x1c,0x0e,0x00, 0x1c,0x15,0x00,
  0x1c,0x1c,0x00, 0x15,0x1c,0x00, 0x0e,0x1c,0x00, 0x07,0x1c,0x00,
  0x00,0x1c,0x00, 0x00,0x1c,0x07, 0x00,0x1c,0x0e, 0x00,0x1c,0x15,
  0x00,0x1c,0x1c, 0x00,0x15,0x1c, 0x00,0x0e,0x1c, 0x00,0x07,0x1c, // 128

  0x0e,0x0e,0x1c, 0x11,0x0e,0x1c, 0x15,0x0e,0x1c, 0x18,0x0e,0x1c,
  0x1c,0x0e,0x1c, 0x1c,0x0e,0x18, 0x1c,0x0e,0x15, 0x1c,0x0e,0x11,
  0x1c,0x0e,0x0e, 0x1c,0x11,0x0e, 0x1c,0x15,0x0e, 0x1c,0x18,0x0e,
  0x1c,0x1c,0x0e, 0x18,0x1c,0x0e, 0x15,0x1c,0x0e, 0x11,0x1c,0x0e,
  0x0e,0x1c,0x0e, 0x0e,0x1c,0x11, 0x0e,0x1c,0x15, 0x0e,0x1c,0x18,
  0x0e,0x1c,0x1c, 0x0e,0x18,0x1c, 0x0e,0x15,0x1c, 0x0e,0x11,0x1c,
  0x14,0x14,0x1c, 0x16,0x14,0x1c, 0x18,0x14,0x1c, 0x1a,0x14,0x1c,
  0x1c,0x14,0x1c, 0x1c,0x14,0x1a, 0x1c,0x14,0x18, 0x1c,0x14,0x16,
  0x1c,0x14,0x14, 0x1c,0x16,0x14, 0x1c,0x18,0x14, 0x1c,0x1a,0x14,
  0x1c,0x1c,0x14, 0x1a,0x1c,0x14, 0x18,0x1c,0x14, 0x16,0x1c,0x14,
  0x14,0x1c,0x14, 0x14,0x1c,0x16, 0x14,0x1c,0x18, 0x14,0x1c,0x1a,
  0x14,0x1c,0x1c, 0x14,0x1a,0x1c, 0x14,0x18,0x1c, 0x14,0x16,0x1c,
  0x00,0x00,0x10, 0x04,0x00,0x10, 0x08,0x00,0x10, 0x0c,0x00,0x10,
  0x10,0x00,0x10, 0x10,0x00,0x0c, 0x10,0x00,0x08, 0x10,0x00,0x04,
  0x10,0x00,0x00, 0x10,0x04,0x00, 0x10,0x08,0x00, 0x10,0x0c,0x00,
  0x10,0x10,0x00, 0x0c,0x10,0x00, 0x08,0x10,0x00, 0x04,0x10,0x00,

  0x00,0x10,0x00, 0x00,0x10,0x04, 0x00,0x10,0x08, 0x00,0x10,0x0c,
  0x00,0x10,0x10, 0x00,0x0c,0x10, 0x00,0x08,0x10, 0x00,0x04,0x10,
  0x08,0x08,0x10, 0x0a,0x08,0x10, 0x0c,0x08,0x10, 0x0e,0x08,0x10,
  0x10,0x08,0x10, 0x10,0x08,0x0e, 0x10,0x08,0x0c, 0x10,0x08,0x0a,
  0x10,0x08,0x08, 0x10,0x0a,0x08, 0x10,0x0c,0x08, 0x10,0x0e,0x08,
  0x10,0x10,0x08, 0x0e,0x10,0x08, 0x0c,0x10,0x08, 0x0a,0x10,0x08,
  0x08,0x10,0x08, 0x08,0x10,0x0a, 0x08,0x10,0x0c, 0x08,0x10,0x0e,
  0x08,0x10,0x10, 0x08,0x0e,0x10, 0x08,0x0c,0x10, 0x08,0x0a,0x10,
  0x0b,0x0b,0x10, 0x0c,0x0b,0x10, 0x0d,0x0b,0x10, 0x0f,0x0b,0x10,
  0x10,0x0b,0x10, 0x10,0x0b,0x0f, 0x10,0x0b,0x0d, 0x10,0x0b,0x0c,
  0x10,0x0b,0x0b, 0x10,0x0c,0x0b, 0x10,0x0d,0x0b, 0x10,0x0f,0x0b,
  0x10,0x10,0x0b, 0x0f,0x10,0x0b, 0x0d,0x10,0x0b, 0x0c,0x10,0x0b,
  0x0b,0x10,0x0b, 0x0b,0x10,0x0c, 0x0b,0x10,0x0d, 0x0b,0x10,0x0f,
  0x0b,0x10,0x10, 0x0b,0x0f,0x10, 0x0b,0x0d,0x10, 0x0b,0x0c,0x10,
  0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00, 0x00,0x00,0x00,
  0x00,0x00,0x00, 0x00,0xFF,0x00, 0xFF,0xFF,0xFF, 0x00,0x00,0x00 //256
};

// cirrus_mode_t mode = {0x75,0x11a,{MM_DIRECT,1280,1024,16,8,16,SEG_GRAPH},0xe1,cseq_1280x1024x16,cgraph_svgacolor,ccrtc_1280x1024x16};/
cirrus_mode_t mode = {0x6d,0x107,{MM_PACKED,1280,1024,8,8,16,SEG_GRAPH},0x00,cseq_1280x1024x8,cgraph_svgacolor,ccrtc_1280x1024x8};

void set_graphics_mode(){


    outw(0x612, VGAREG_SEQU_ADDRESS);
    int i;
    for(i = 0; i < 18; i++){

        outw(mode.seq[i], VGAREG_SEQU_ADDRESS);

    }

    for(i = 0; i < 13; i++){

        outw(mode.graph[i], VGAREG_GRDC_ADDRESS);

    }

    uint16_t port;
    uint8_t temp = inb(VGAREG_READ_MISC_OUTPUT);
    if(temp & 1) port = VGAREG_VGA_CRTC_ADDRESS;
    else port = VGAREG_MDA_CRTC_ADDRESS;

    for(i = 0; i < 24; i++){

        outw(mode.crtc[i], port);

    }

    uint8_t gar;
    outb(0x00, VGAREG_PEL_MASK);
    gar = inb(VGAREG_PEL_MASK);
    gar = inb(VGAREG_PEL_MASK);
    gar = inb(VGAREG_PEL_MASK);
    gar = inb(VGAREG_PEL_MASK);
    outb(mode.hidden_dac, VGAREG_PEL_MASK);
    outb(0xff, VGAREG_PEL_MASK);

    uint8_t on = 0x1;
    uint8_t off = 0x01;

    inb(VGAREG_ACTL_RESET);
    uint8_t orig = inb(VGAREG_ACTL_ADDRESS);
    outb(0x10, VGAREG_ACTL_ADDRESS);
    uint8_t v = inb(VGAREG_ACTL_READ_DATA);
    outb((v & ~off) | on, VGAREG_ACTL_WRITE_DATA);
    outb(orig, VGAREG_ACTL_ADDRESS);

    inb(VGAREG_ACTL_RESET);
    outb(0x20, VGAREG_ACTL_ADDRESS);

    outb(0x00, VGAREG_DAC_WRITE_ADDRESS);
    int index = 0;
    for(i = 0; i < 256; i++){

        outb(palette3[index], VGAREG_DAC_DATA);
        index++;
        outb(palette3[index], VGAREG_DAC_DATA);
        index++;
        outb(palette3[index], VGAREG_DAC_DATA);
        index++;

    }

}

void setup_BLT(){

    uint8_t tt;
    outb(BLT_STATUS, BLT_ADDRESS);
    outb(0x04, BLT_DATA);
        
    outb(BLT_STATUS, BLT_ADDRESS);
    outb(0x00, BLT_DATA);

    outb(0x0B, BLT_ADDRESS);
    tt = inb(BLT_DATA);
    tt |= 0x20;
    tt &= ~0x01;
    outb(0x0B, BLT_ADDRESS);
    outb(tt, BLT_DATA);

    outb(0x17, 0x3c4);
    tt = inb(0x3c5);
    tt = tt | 0x04;
    tt = tt & ~0x40;
    outb(0x17, 0x3c4);
    outb(tt, 0x3c5);

}

uint32_t setup_graphics_mode(){

    uint32_t word = pciGetBar0(0, 2);
    word = word & 0xFFFFFFF0;
    setup_video_mem(word);
    char * videomem = (char *)word;

    memset((void * ) videomem, 0, FOURMB * 4);
    set_graphics_mode();
    return word;

}

void poll_blt(){

    char * vid = (char *) VIDEO;

    while(1){
        char c = vid[BLT_START_STATUS_MMIO];
        if((c & BLT_STATUS_BIT) == 0x00) break;
    }

}

void blt_draw_image(uint32_t src, uint32_t dst, uint16_t width, uint16_t height, uint16_t src_pitch){

    blt_operation_mmio(0, 0, width - 1, height - 1, 1280*2, src_pitch, dst, src, 0x00, 0x00, BLT_DST_ROP, 0x00, 0);

}

void blt_draw_image_color_expand(uint32_t background, uint32_t foreground, uint32_t src, uint32_t dst, uint16_t width, uint16_t height, uint16_t src_pitch){

    blt_operation_mmio(background, foreground, width - 1, height - 1, 1280*2, src_pitch, dst, src, 0x00, BLT_COLOR_EXPANSION | BLT_16BPP_EXPANSION, BLT_DST_ROP, 0x00, 0);  

}

void blt_write_raw_bytes(uint32_t src, uint32_t dst, uint16_t width, uint16_t height, uint16_t dst_pitch, uint16_t src_pitch){

    blt_operation_mmio(0, 0, width - 1, height - 1, dst_pitch, src_pitch, dst, src, 0x00, 0x00, BLT_DST_ROP, 0x00, 0);

}

void blt_operation_mmio(uint32_t background, uint32_t foreground, uint16_t width, uint16_t height, uint16_t dst_pitch, uint16_t src_pitch, uint32_t dst, uint32_t src, uint8_t dst_lsc, uint8_t mode, uint8_t rop, uint8_t mode_ext, uint16_t transparent){

    unsigned long flags;
    cli_and_save(flags);

    char * vid = (char *) VIDEO;

    poll_blt();

    vid[BACKGROUND_0_MMIO] = background;
    vid[BACKGROUND_1_MMIO] = (background >> 8);
    vid[BACKGROUND_2_MMIO] = (background >> 16);
    vid[BACKGROUND_3_MMIO] = (background >> 24);

    vid[FOREGROUND_0_MMIO] = foreground;
    vid[FOREGROUND_1_MMIO] = (foreground >> 8);
    vid[FOREGROUND_2_MMIO] = (foreground >> 16);
    vid[FOREGROUND_3_MMIO] = (foreground >> 24);

    vid[WIDTH_0_MMIO] = width;
    vid[WIDTH_1_MMIO] = (width >> 8);

    vid[HEIGHT_0_MMIO] = height;
    vid[HEIGHT_1_MMIO] = (height >> 8);

    vid[DEST_PITCH_0_MMIO] = dst_pitch;
    vid[DEST_PITCH_1_MMIO] = (dst_pitch >> 8);

    vid[SRC_PITCH_0_MMIO] = src_pitch;
    vid[SRC_PITCH_1_MMIO] = (src_pitch >> 8);

    vid[DEST_START_0_MMIO] = dst;
    vid[DEST_START_1_MMIO] = (dst >> 8);
    vid[DEST_START_2_MMIO] = (dst >> 16);

    vid[SRC_START_0_MMIO] = src;
    vid[SRC_START_1_MMIO] = (src >> 8);
    vid[SRC_START_2_MMIO] = (src >> 16);

    vid[DEST_LSC_MMIO] = dst_lsc;
    vid[BLT_MODE_MMIO] = mode;
    vid[BLT_ROP_MMIO] = rop;
    vid[BLT_MODE_EXT_MMIO] = mode_ext;

    vid[TRANS_0_MMIO] = transparent;
    vid[TRANS_1_MMIO] = (transparent >> 8);

    vid[BLT_START_STATUS_MMIO] = BLT_START_OPERATION;

    restore_flags(flags);

}

void blt_operation_mmio_system(uint32_t background, uint32_t foreground, uint16_t width, uint16_t height, uint16_t dst_pitch, uint16_t src_pitch, uint32_t dst, uint32_t * src, uint8_t dst_lsc, uint8_t mode, uint8_t rop, uint8_t mode_ext, uint16_t transparent, uint32_t length){

    unsigned long flags;
    cli_and_save(flags);

    char * vid = (char *) VIDEO;
    uint32_t * fb  = (uint32_t *) (0xFC000000);
    int i;

    poll_blt();

    vid[BACKGROUND_0_MMIO] = background;
    vid[BACKGROUND_1_MMIO] = (background >> 8);
    vid[BACKGROUND_2_MMIO] = (background >> 16);
    vid[BACKGROUND_3_MMIO] = (background >> 24);

    vid[FOREGROUND_0_MMIO] = foreground;
    vid[FOREGROUND_1_MMIO] = (foreground >> 8);
    vid[FOREGROUND_2_MMIO] = (foreground >> 16);
    vid[FOREGROUND_3_MMIO] = (foreground >> 24);

    vid[WIDTH_0_MMIO] = width;
    vid[WIDTH_1_MMIO] = (width >> 8);

    vid[HEIGHT_0_MMIO] = height;
    vid[HEIGHT_1_MMIO] = (height >> 8);

    vid[DEST_PITCH_0_MMIO] = dst_pitch;
    vid[DEST_PITCH_1_MMIO] = (dst_pitch >> 8);

    // vid[SRC_PITCH_0_MMIO] = src_pitch;
    // vid[SRC_PITCH_1_MMIO] = (src_pitch >> 8);

    vid[DEST_START_0_MMIO] = dst;
    vid[DEST_START_1_MMIO] = (dst >> 8);
    vid[DEST_START_2_MMIO] = (dst >> 16);

    // vid[SRC_START_0_MMIO] = 0;
    // vid[SRC_START_1_MMIO] = 0;
    // vid[SRC_START_2_MMIO] = 0;

    vid[DEST_LSC_MMIO] = dst_lsc;
    vid[BLT_MODE_MMIO] = mode;
    vid[BLT_ROP_MMIO] = rop;
    vid[BLT_MODE_EXT_MMIO] = mode_ext;

    vid[TRANS_0_MMIO] = transparent;
    vid[TRANS_1_MMIO] = (transparent >> 8);

    vid[BLT_START_STATUS_MMIO] = BLT_START_OPERATION;

    for(i = 0; i < length; i++){

        *(fb + i) = (uint32_t)(src);

    }

    restore_flags(flags);

}
